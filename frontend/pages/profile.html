<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile | Tripeaz Taxi Partners</title>
    <link rel="stylesheet" href="../css/pages/dashboard.css" />
    <link rel="stylesheet" href="../css/pages/profile.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Critical: Define logout function immediately in head to ensure it's available for inline onclick -->
    <script>
      // Define logout function immediately - before body loads
      window.logout = function() {
        // Show in-app confirmation modal instead of browser confirm
        const modal = document.getElementById('logoutConfirmModal');
        if (modal) {
          modal.classList.add('show');
        } else {
          // Fallback to browser confirm if modal not found
          if (confirm("Are you sure you want to logout?")) {
            performLogout();
          }
        }
      };
      
      // Function to perform actual logout
      window.performLogout = function() {
        (async () => {
          try {
            // Try to call API if available
            if (typeof ApiService !== 'undefined') {
              const apiService = new ApiService();
              try {
                await apiService.logout();
              } catch (e) {
                console.error('Logout API error:', e);
              }
            }
          } catch (error) {
            console.error('Logout error:', error);
          } finally {
            // Always clear storage and redirect
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "index.html";
          }
        })();
      };
      
      // Function to close logout modal
      window.closeLogoutModal = function() {
        const modal = document.getElementById('logoutConfirmModal');
        if (modal) {
          modal.classList.remove('show');
        }
      };
      
      // Function to confirm logout
      window.confirmLogout = function() {
        closeLogoutModal();
        performLogout();
      };
      
      console.log('Logout functions defined in head:', typeof window.logout);
    </script>
    <!-- Immediately load and display user data from localStorage -->
    <script>
      // Immediately load and display user data from localStorage
      (function() {
        try {
          const userStr = localStorage.getItem('user');
          if (userStr) {
            const user = JSON.parse(userStr);
            const name = user.name || user.fullName || 'User';
            const mobile = user.mobile || user.phone || '';
            
            // Format phone number
            function formatPhone(mobile) {
              if (!mobile) return '';
              const digits = mobile.replace(/\D/g, '');
              if (digits.length === 10) {
                return `+91 ${digits.slice(0, 5)} ${digits.slice(5)}`;
              }
              if (digits.length === 12 && digits.startsWith('91')) {
                return `+${digits.slice(0, 2)} ${digits.slice(2, 7)} ${digits.slice(7)}`;
              }
              return `+91 ${mobile}`;
            }
            
            // Update DOM immediately when available
            function updateProfileDisplay() {
              const nameEl = document.getElementById('profileName');
              const phoneEl = document.getElementById('profilePhone');
              
              if (nameEl) {
                nameEl.textContent = name;
                console.log('‚úÖ Profile name updated immediately:', name);
              }
              if (phoneEl) {
                phoneEl.textContent = formatPhone(mobile) || 'Loading...';
                console.log('‚úÖ Profile phone updated immediately:', formatPhone(mobile));
              }
            }
            
            // Try to update immediately
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', updateProfileDisplay);
            } else {
              updateProfileDisplay();
            }
            
            // Also try after a small delay to ensure elements exist
            setTimeout(updateProfileDisplay, 50);
            setTimeout(updateProfileDisplay, 200);
          } else {
            console.log('No user data in localStorage yet');
          }
        } catch (e) {
          console.error('Error loading user data in head:', e);
        }
      })();
    </script>
  </head>
  <body>
    <!-- Header -->
    <header class="main-header">
      <div class="header-content">
        <!-- Logo -->
        <div class="header-logo">
          <h2 class="logo-text">Tripeaz Taxi</h2>
          <span class="logo-badge">Partners</span>
        </div>

        <!-- Header Action Buttons -->
        <div class="header-actions">
          <!-- Support Button -->
          <button class="support-button" onclick="handleSupportClick()" aria-label="Support">
            <svg class="support-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 1C7.03 1 3 5.03 3 10V16C3 17.1 3.9 18 5 18H7V12H5V10C5 6.13 8.13 3 12 3C15.87 3 19 6.13 19 10V12H17V18H19C20.1 18 21 17.1 21 16V10C21 5.03 16.97 1 12 1Z"/>
              <path d="M9 21H15V23H9V21Z"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="header-border"></div>
    </header>

    <!-- Profile Top Section -->
    <div class="profile-top">
      <div class="profile-avatar">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23FFB300'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='white' font-size='40'%3Eüë§%3C/text%3E%3C/svg%3E" alt="Profile" id="profileAvatar" />
        <div class="edit-icon">‚úèÔ∏è</div>
      </div>
      <h1 class="profile-name" id="profileName">Loading...</h1>
      <div class="profile-phone" id="profilePhone">Loading...</div>
      <div class="verified-badge" id="verifiedBadge" style="display: none;">
        <span class="verify-icon">‚úì</span>
        <span>Verified</span>
      </div>
      <div class="profile-completion">
        <div class="completion-bar">
          <div class="completion-fill" id="completionFill" style="width: 0%"></div>
        </div>
        <div class="completion-text" id="completionText">0% Profile Complete</div>
      </div>
    </div>

    <!-- Profile Content -->
    <main class="profile-main" style="padding-bottom: 100px">
      <!-- Account Section -->
      <div class="profile-section">
        <h2 class="section-title">üßæ Account</h2>
        <div class="option-list">
          <div class="option-item" onclick="editAndVerify()">
            <span class="option-label">Edit & Verify</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item" onclick="viewProfile()">
            <span class="option-label">View Profile</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item" onclick="downloadQR()">
            <span class="option-label">Download Profile QR</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item" onclick="showMembership()">
            <span class="option-label">Tripeaz Taxi Membership</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item" onclick="openWallet()">
            <span class="option-label">Wallet</span>
            <span class="option-badge">‚Çπ1,250</span>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="profile-section">
        <h2 class="section-title">‚öôÔ∏è Settings</h2>
        <div class="option-list">
          <div class="option-item" onclick="changeLanguage()">
            <span class="option-label">Change Language</span>
            <span class="option-value">English</span>
          </div>
          <div class="option-item" onclick="showTerms()">
            <span class="option-label">Terms & Policy</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item" onclick="appSettings()">
            <span class="option-label">App Settings</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item">
            <span class="option-label">Dark Mode</span>
            <label class="toggle-switch">
              <input type="checkbox" checked />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- Support Section -->
      <div class="profile-section">
        <h2 class="section-title">üí¨ Support</h2>
        <div class="option-list">
          <div class="option-item" onclick="contactSupport()">
            <span class="option-label">Tripeaz Taxi Support</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item" onclick="logout()">
            <span class="option-label danger">Logout</span>
            <span class="option-arrow">‚Üí</span>
          </div>
          <div class="option-item" onclick="deleteAccount()">
            <span class="option-label danger">Delete Account</span>
            <span class="option-arrow">‚Üí</span>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer Navigation -->
    <footer class="footer-nav">
      <nav class="nav-tabs">
        <!-- Tab 1: Booking Available -->
        <button
          class="nav-tab"
          data-tab="available"
          onclick="navigateToTab('available')"
        >
          <div class="tab-icon">üöñ</div>
          <span class="tab-label">Available</span>
        </button>

        <!-- Tab 2: My Features -->
        <button
          class="nav-tab"
          data-tab="features"
          onclick="navigateToTab('features')"
        >
          <div class="tab-icon">‚≠ê</div>
          <span class="tab-label">Features</span>
        </button>

        <!-- Tab 3: Floating Action Button (FAB) -->
        <button
          class="nav-tab fab-button"
          onclick="toggleFABPopup()"
          id="fabButton"
          aria-label="Add New Item"
          aria-expanded="false"
        >
          <div class="fab-icon nav-fab-icon">+</div>
        </button>

        <!-- Tab 4: My Bookings -->
        <button
          class="nav-tab"
          data-tab="bookings"
          onclick="navigateToTab('bookings')"
        >
          <div class="tab-icon">üìã</div>
          <span class="tab-label">Bookings</span>
        </button>

        <!-- Tab 5: Profile -->
        <button
          class="nav-tab active"
          data-tab="profile"
          onclick="navigateToTab('profile')"
        >
          <div class="tab-icon">üë§</div>
          <span class="tab-label">Profile</span>
        </button>
      </nav>
    </footer>

    <!-- Support Modal -->
    <div class="support-modal" id="supportModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Support & Help</h3>
          <button class="close-modal" onclick="closeSupportModal()">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <div class="support-option" onclick="contactSupport()">
            <span class="support-option-icon">üí¨</span>
            <div>
              <h4>Live Chat</h4>
              <p>Get instant help from our support team</p>
            </div>
          </div>
          <div class="support-option" onclick="whatsappSupport()">
            <span class="support-option-icon">üì±</span>
            <div>
              <h4>WhatsApp</h4>
              <p>Chat with us on WhatsApp</p>
            </div>
          </div>
          <div class="support-option" onclick="callSupport()">
            <span class="support-option-icon">üìû</span>
            <div>
              <h4>Call Us</h4>
              <p>+91-9103774717</p>
            </div>
          </div>
          <div class="support-option" onclick="emailSupport()">
            <span class="support-option-icon">‚úâÔ∏è</span>
            <div>
              <h4>Email</h4>
              <p>support@tripeaztaxi.com</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="logout-confirm-modal" id="logoutConfirmModal">
      <div class="modal-overlay" onclick="closeLogoutModal()"></div>
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-icon">üö™</div>
        <h3 class="modal-title">Logout</h3>
        <p class="modal-message">Are you sure you want to logout?</p>
        <div class="modal-actions">
          <button class="modal-btn cancel-btn" onclick="closeLogoutModal()">
            Cancel
          </button>
          <button class="modal-btn confirm-btn" onclick="confirmLogout()">
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- FAB Popup Menu -->
    <div
      class="fab-popup-overlay"
      id="fabPopupOverlay"
      onclick="closeFABPopup()"
    >
      <div class="fab-popup-menu" onclick="event.stopPropagation()">
        <div class="fab-popup-option" onclick="handleUploadBooking()">
          <span class="fab-option-icon">üìÑ</span>
          <span class="fab-option-label">Upload New Booking</span>
        </div>

        <div class="fab-popup-option cancel" onclick="closeFABPopup()">
          <span class="fab-option-icon">‚úï</span>
          <span class="fab-option-label">Cancel</span>
        </div>
      </div>
    </div>

    <!-- Chat Bot Window -->
    <div class="chatbot-window" id="chatbotWindow">
      <div class="chatbot-header">
        <h3>Customer Support</h3>
        <button
          class="close-chatbot-btn"
          onclick="toggleChatbot()"
          aria-label="Close chat"
        >
          ‚úï
        </button>
      </div>
      <div class="chatbot-messages" id="chatbotMessages">
        <div class="chat-message bot-message">
          <p>Hello! üëã Welcome to Tripeaz Taxi Partners</p>
        </div>
      </div>
      <div class="chatbot-input-container">
        <input
          type="text"
          class="chatbot-input"
          id="chatbotInput"
          placeholder="Type your message..."
          onkeypress="handleChatInput(event)"
        />
        <button class="chatbot-send-btn" onclick="sendChatMessage()">
          <span class="send-icon">üì§</span>
        </button>
      </div>
    </div>

    <script src="../js/services/api.js"></script>
    <script src="../js/pages/profile.js"></script>
    <script src="../js/pages/dashboard.js"></script>
  </body>
</html>
